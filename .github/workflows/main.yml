name: Update Sub

on:
  schedule:
    # 每天北京时间早8点、10点、晚8点自动运行
    - cron: '0 0,2,12 * * *'
  workflow_dispatch: # 允许手动点击运行

permissions:
  contents: write

jobs:
  update-subscription:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: pip install requests

    - name: Run Update Script
      run: |
        python -c "
        import requests
        import datetime
        import sys

        # --- 配置区 ---
        # 1. 严格保留双斜杠
        base_url = 'http://62.234.98.136//houtai//applinks2//'
        # 2. 你的文件名
        save_file_name = 'vip_link_8848.txt'
        
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'http://62.234.98.136/',
            'Accept': '*/*'
        }

        # 获取北京时间
        utc_now = datetime.datetime.utcnow()
        beijing_now = utc_now + datetime.timedelta(hours=8)
        
        print(f'北京时间: {beijing_now.strftime(\'%Y-%m-%d %H:%M\')}')
        print('执行策略: 今天G -> 今天P -> 昨天G -> 昨天P')

        found_content = ''
        success_info = ''

        # 构造尝试队列 (按优先级绝对排序)
        candidates = []
        for day_offset in [0, -1]: # 0是今天，-1是昨天
            d = beijing_now + datetime.timedelta(days=day_offset)
            date_str = f'{d.month}{d.day:02d}' # 格式 Mdd (如 105)
            
            # 这里的顺序决定了优先级：先G后P
            candidates.append({'url': f'{base_url}{date_str}g.txt', 'type': f'G版 ({date_str})'})
            candidates.append({'url': f'{base_url}{date_str}p.txt', 'type': f'P版 ({date_str})'})

        # 开始按顺序逐个尝试
        for item in candidates:
            url = item['url']
            ver = item['type']
            try:
                print(f'正在检测 {ver} ... ', end='')
                # 设置5秒超时，快速跳过无效链接
                r = requests.get(url, headers=headers, timeout=5)
                
                # 判定成功：状态码200 且 文件内容长度 > 300字节 (排除空文件或报错页)
                if r.status_code == 200 and len(r.text) > 300:
                    print('✅ 成功！')
                    print(f'>> 锁定目标: {ver} 有效，停止后续检测。')
                    found_content = r.text
                    success_info = ver
                    break # <--- 找到了就立刻停止，确保只要今天G在，就不会用昨天的
                else:
                    print(f'❌ 无效 (状态:{r.status_code})')
            except Exception as e:
                print(f'❌ 出错')

        # 保存结果
        if found_content:
            with open(save_file_name, 'w', encoding='utf-8') as f:
                f.write(found_content)
            print('-' * 30)
            print(f'最终更新版本: {success_info}')
            print(f'文件已保存为: {save_file_name}')
        else:
            print('\n严重错误: 今天和昨天的 G/P 版全部尝试失败。')
            exit(1)
        "

    - name: Commit and Push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add vip_link_8848.txt
        git diff --quiet && git diff --staged --quiet || (git commit -m "Auto update sub" && git push)
